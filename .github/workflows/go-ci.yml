name: Go CI

on:
  push:
    branches:
      - main

jobs:
    static-code-analysis:
        name: Static Code Analysis
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
                fetch-depth: 0
          
          - name: Install golangci-lint
            uses: golangci/golangci-lint-action@v2
            with:
                version: latest
                args: run ./...

          - name: Install staticcheck
            run: |
                curl -sSfL https://raw.githubusercontent.com/staticcheck/staticcheck/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest

          - name: Run go vet
            run: go vet ./...
    build-docker-image:
        name: Build Docker Image
        runs-on: ubuntu-latest
        needs: static-code-analysis
        strategy:
            matrix:
                go-version: ['1.21.8', '1.22.1']
        steps:
            - uses: actions/checkout@v4
            - name: Setup Go ${{ matrix.go-version }}
              uses: actions/setup-go@v4
              with:
                  go-version: ${{ matrix.go-version }}

            - name: Display Go version
              run: go version

            - name: Setup SHA
              run: echo "GITHUB_SHA=${GITHUB_SHA}" >> $GITHUB_ENV

            - name: Build the Docker image
              run: docker build . --file Dockerfile --tag ghcr.io/hanqqv/fun-exercise-api:${{ env.GITHUB_SHA }}

            - name: Login ghcr.io
              uses: docker/login-action@v1.8.0
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}
                logout: true

            - name: Push to GitHub Container Registry
              uses: docker/build-push-action@v2
              with:
                context: .
                tags: |
                    ghcr.io/hanqqv/fun-exercise-api:${{ env.GITHUB_SHA }}
                # build on feature branches, push only on main branch
                push: ${{ github.ref == 'refs/heads/main' }}

            - name: Image digest
              run: echo ${{ steps.docker_build.outputs.digest }}
